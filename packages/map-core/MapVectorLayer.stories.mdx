import { Meta, Preview, Story, Props, Source, Description } from '@storybook/addon-docs/blocks';
import { withKnobs, object, number, boolean, text, select } from '@storybook/addon-knobs'
import { RplContainer, RplRow, RplCol } from '@dpc-sdp/ripple-grid'
import YourvicMapCore from './index.vue'
import YourvicMapTileLayer from './MapTileLayer.vue'
import YourvicMapVectorLayer from './MapVectorLayer.vue'

<Meta title="Maps/Vector Layer" component={ YourvicMapVectorLayer } decorators={ [withKnobs] } />

# Map Tile Layer

<Description of={ YourvicMapVectorLayer } type='docgen' />

## Installation

```shell
npm install @dpc-sdp/yourvic-map-core --save
```

## Import

```javascript
import { YourvicMapCore, YourvicMapVectorLayer } from '@dpc-sdp/yourvic-map-core'
```

## Usage

One or more ```yourvic-map-vector-layer``` components can be declared as children of ```yourvic-map-core```.

```html
<yourvic-map-core
  :containerStyle="{ position: 'relative', width: '100%', height:'100vh' }"
  :center="[16138405.843820328, -4552817.013522999]"
>
  <yourvic-map-vector-layer
    url="https://openlayers.org/en/latest/examples/data/geojson/countries.geojson"
    dataFormat="GeoJSON"
  />
</yourvic-map-core>
```

## Props

<Props of={ YourvicMapVectorLayer } />

## Configurable Layer

This example provides options to test different layer configurations.

<Preview>
  <Story name="Configurable Layer">
    {
      {
        components: { YourvicMapCore, YourvicMapTileLayer, YourvicMapVectorLayer },
        template: `<yourvic-map-core
          :containerStyle="containerStyle"
          :baseMapUrl="baseMapUrl"
          :baseMapAttributions="baseMapAttributions"
          :enableMapboxWatermark="enableMapboxWatermark"
          :center="center"
          :projection="mapProjection == '' ? undefined : mapProjection"
          :zoom="zoom"
          :minZoom="minZoom"
          :maxZoom="maxZoom"
          enableZoomControl
          enableAttributionControl
          enableFullScreenControl
          enablePanInteraction
          enableZoomInteraction
          enableRotateInteraction
        >
          <yourvic-map-tile-layer
            type="OSM"
          />
          <yourvic-map-vector-layer
            :url="decodeURIComponent(layerUrl.url)"
            :dataFormat="layerDataFormat"
            :loadingStrategy="layerLoadingStrategy"
            :projection="layerProjection == '' ? undefined : layerProjection"
            :extent="layerExtent.length && layerExtent.length > 0 ? layerExtent : undefined"
            :attributions="layerAttributions"
            :opacity="layerOpacity"
          />
        </yourvic-map-core>`,
        props: {
          layerUrl: {
            default: () => object('URL', {
              url: 'https://gis-app.prod.myvictoria.vic.gov.au/geoserver/myvic/wfs%3FSERVICE=wfs%26VERSION=1.0.0%26REQUEST=GetFeature%26TYPENAME=myvic:lga%26SRSNAME=EPSG:3857%26OUTPUTFORMAT=application/json%26CQL_FILTER=lga_name=%27Yarra%27'
            }, 'layer')
          },
          layerDataFormat: {
            default: select('Data Format', { GeoJSON: 'GeoJSON', EsriJSON: 'EsriJSON', WFS: 'WFS' }, 'GeoJSON', 'layer')
          },
          layerLoadingStrategy: {
            default: select('Loading Strategy', { all: 'all', bbox: 'bbox', tile: 'tile' }, 'bbox', 'layer')
          },
          layerProjection: {
            default: () => text('Projection', '', 'layer')
          },
          layerExtent: {
            default: () => object('Extent', [], 'layer')
          },
          layerAttributions: {
            default: () => object('Attributions', [], 'layer')
          },
          layerOpacity: {
            default: () => number('Opacity', 1, {}, 'layer')
          },
          baseMapUrl: {
            default: text('Base Map URL', '', 'map')
          },
          baseMapAttributions: {
            default: () => object('Base Map Attributions', [], 'map')
          },
          enableMapboxWatermark: {
            default: boolean('Enable Mapbox Watermark', false, 'map')
          },
          containerStyle: {
            default: () => object('Container Style', { width: '100%', height: '100%' }, 'map')
          },
          center: {
            default: () => object('Center', [16137905.843820328, -4555057.013522999], 'map')
          },
          mapProjection: {
            default: '' // Cannot be updated after map is loaded
          },
          zoom: {
            default: number('Zoom', 11,
              {
                range: true,
                min: 1,
                max: 20,
                step: 1
              },
              'map'
            )
          },
          minZoom: {
            default: number('Min Zoom', 1,
              {
                range: true,
                min: 1,
                max: 20,
                step: 1
              },
              'map'
            )
          },
          maxZoom: {
            default: number('Max Zoom', 20,
              {
                range: true,
                min: 1,
                max: 20,
                step: 1
              },
              'map'
            )
          }
        }
      }
    }
  </Story>
</Preview>

## GeoJSON File

<Preview>
  <Story name="GeoJSON File">
    {
      {
        components: { YourvicMapCore, YourvicMapTileLayer, YourvicMapVectorLayer },
        template: `<yourvic-map-core
          :containerStyle="{ position: 'relative', width: '100%', height:'100vh' }"
          :center="[16138405.843820328, -4552817.013522999]"
          :zoom="1"
        >
          <yourvic-map-tile-layer
            type="OSM"
          />
          <yourvic-map-vector-layer
            url="https://openlayers.org/en/latest/examples/data/geojson/countries.geojson"
            dataFormat="GeoJSON"
          />
        </yourvic-map-core>`
      }
    }
  </Story>
</Preview>

## WFS BBOX Load Strategy

Using a urlFunction which accepts the current map extent, a URL can be generated to request features by BBOX

<Preview>
  <Story name="WFS BBOX Load Strategy">
    {
      {
        components: { YourvicMapCore, YourvicMapTileLayer, YourvicMapVectorLayer },
        template: `<yourvic-map-core
          :containerStyle="{ position: 'relative', width: '100%', height:'100vh' }"
          :center="[16137905.843820328, -4555057.013522999]"
          :zoom="12"
          :minZoom="10"
        >
          <yourvic-map-tile-layer
            type="OSM"
          />
          <yourvic-map-vector-layer
            :urlFunction="buildUrl"
            dataFormat="GeoJSON"
            loadingStrategy="bbox"
          />
        </yourvic-map-core>`,
        methods: {
          buildUrl: function (extent, resolution, projection) {
            return 'https://gis-app.prod.myvictoria.vic.gov.au/geoserver/myvic/wfs?SERVICE=wfs&VERSION=1.1.0&REQUEST=GetFeature&TYPENAME=myvic:suburb&SRSNAME=' + projection.getCode() + '&OUTPUTFORMAT=application/json&bbox=' + extent.join(',') + ',' + projection.getCode()
          }
        }
      }
    }
  </Story>
</Preview>

## WFS Tile Load Strategy

Using a urlFunction which accepts the a tile extent, a URL can be generated to request features by BBOX

<Preview>
  <Story name="WFS Tile Load Strategy">
    {
      {
        components: { YourvicMapCore, YourvicMapTileLayer, YourvicMapVectorLayer },
        template: `<yourvic-map-core
          :containerStyle="{ position: 'relative', width: '100%', height:'100vh' }"
          :center="[16137905.843820328, -4555057.013522999]"
          :zoom="12"
          :minZoom="10"
        >
          <yourvic-map-tile-layer
            type="OSM"
          />
          <yourvic-map-vector-layer
            :urlFunction="buildUrl"
            dataFormat="GeoJSON"
            loadingStrategy="tile"
          />
        </yourvic-map-core>`,
        methods: {
          buildUrl: function (extent, resolution, projection) {
            return 'https://gis-app.prod.myvictoria.vic.gov.au/geoserver/myvic/wfs?SERVICE=wfs&VERSION=1.1.0&REQUEST=GetFeature&TYPENAME=myvic:suburb&SRSNAME=' + projection.getCode() + '&OUTPUTFORMAT=application/json&bbox=' + extent.join(',') + ',' + projection.getCode()
          }
        }
      }
    }
  </Story>
</Preview>

## WFS with Filter

Filter params can be incorporated into the URL for WFS requests. Note that bbox/tile loading strategies cannot be used
alongside a CQL_FILTER (this is not supported by Geoserver).

<Preview>
  <Story name="WFS with Filter">
    {
      {
        components: { YourvicMapCore, YourvicMapTileLayer, YourvicMapVectorLayer },
        template: `<yourvic-map-core
          :containerStyle="{ position: 'relative', width: '100%', height:'100vh' }"
          :center="[16137905.843820328, -4555057.013522999]"
          :zoom="12"
          :minZoom="10"
        >
          <yourvic-map-tile-layer
            type="OSM"
          />
          <yourvic-map-vector-layer
            :url="layerUrl"
            dataFormat="GeoJSON"
            loadingStrategy="bbox"
          />
        </yourvic-map-core>`,
        props: {
          filter: {
            default: select('Suburb', {
              Fitzroy: 'Fitzroy',
              Melbourne: 'Melbourne',
              Carlton: 'Carlton',
              Collingwood: 'Collingwood'
            }, 'Fitzroy')
          }
        },
        computed: {
          layerUrl: function () {
            return 'https://gis-app.prod.myvictoria.vic.gov.au/geoserver/myvic/wfs?SERVICE=wfs&VERSION=1.1.0&REQUEST=GetFeature&TYPENAME=myvic:suburb&SRSNAME=EPSG:3857&OUTPUTFORMAT=application/json&CQL_FILTER=ssc_name=%27' + this.filter + '%27'
          }
        }
      }
    }
  </Story>
</Preview>
